/**** Start of imports. If edited, may not auto-convert in the playground. ****/
var aoi = 
    /* color: #ff4af0 */
    /* shown: false */
    ee.Geometry.Polygon(
        [[[83.80210765576713, 24.535281619242316],
          [83.93871222635629, 24.493434447652294],
          [84.0044386012064, 24.615296097823585],
          [84.02944939114862, 24.65280146404626],
          [84.04934821096737, 24.682309411712055],
          [84.08332770745106, 24.683428025379584],
          [84.0866840840571, 24.684608950552626],
          [84.10255923484324, 24.711680681710156],
          [84.13971491797216, 24.762760917774994],
          [84.16744523226645, 24.756769889335438],
          [84.17724653145083, 24.781899766916833],
          [84.1547803723049, 24.800176564024653],
          [84.23251545561519, 24.878268480718464],
          [84.28743163617266, 24.938038251785365],
          [84.34097040083174, 24.99498294949471],
          [84.4274676571512, 25.036346278525457],
          [84.45029401671879, 25.085781437408862],
          [84.46934091178055, 25.126496210654157],
          [84.4782599573385, 25.146074052324792],
          [84.48787433535544, 25.157570606796092],
          [84.49818161084477, 25.175278106571984],
          [84.48032872541997, 25.19919429557727],
          [84.43295711876273, 25.146683113318815],
          [84.41717062610351, 25.139857469666417],
          [84.4019027532432, 25.096033220360283],
          [84.36156825376351, 25.070548749654066],
          [84.31626252064603, 25.03323630334425],
          [84.23526125040452, 24.983468720405373],
          [84.0106235855851, 24.733699764960534],
          [83.91366158567264, 24.669122723873958],
          [83.82483627868777, 24.61204582709122],
          [83.84677079313681, 24.54977649985151]]]),
    greenveg = 
    /* color: #52ff88 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[84.2404446565323, 24.958327770908163],
           [84.2415068113022, 24.957325893772765],
           [84.2426762544327, 24.956606093516108],
           [84.24394225708772, 24.957792788986254],
           [84.2415604554825, 24.959689532582146]]],
         [[[84.26366185776521, 24.98308030010497],
           [84.26412319771578, 24.982973325430105],
           [84.26479911438753, 24.98373187111494],
           [84.26406955353548, 24.984140316853175],
           [84.26280355088045, 24.98381939531591]]],
         [[[84.27859639756014, 24.970262126696294],
           [84.28015207878877, 24.96896856459432],
           [84.28251242272188, 24.9721003231307],
           [84.28067779175569, 24.973432755228465]]],
         [[[84.3175541053443, 25.01478997901147],
           [84.31485043865729, 25.011523190035152],
           [84.31386338573981, 25.00864523250825],
           [84.3154297958045, 25.00782850254719],
           [84.3175541053443, 25.009150824524447],
           [84.31927071911383, 25.01156208089124],
           [84.31963549953986, 25.013856619600602]]],
         [[[83.88172102445898, 24.62036922329362],
           [83.88481092924414, 24.617911328032694],
           [83.88674211973486, 24.62009612620621],
           [83.88322306150732, 24.622436939027022]]],
         [[[83.93146237387703, 24.627116697107578],
           [83.92871579184578, 24.625556218516476],
           [83.92759999289558, 24.620796638495527],
           [83.92502507224128, 24.619392137635483],
           [83.92699917807624, 24.616895208262502],
           [83.93403729453132, 24.619001995707723],
           [83.93566807761238, 24.62415177112785]]],
         [[[83.96682461752937, 24.684372776126892],
           [83.97197445883796, 24.678211598611167],
           [83.97918423667, 24.6833589324016],
           [83.97334774985359, 24.68827209822464]]],
         [[[84.19450222216084, 24.916983455179594],
           [84.19326840601398, 24.91697372499209],
           [84.19243155680134, 24.916701279430388],
           [84.19210969171955, 24.916010432629758],
           [84.19161616526081, 24.914706570378574],
           [84.19153033457233, 24.914190859863574],
           [84.19365464411213, 24.913441616217124],
           [84.19583259783222, 24.915660142632706],
           [84.19657288752033, 24.916545595982086]]],
         [[[83.87074885590017, 24.63609915918026],
           [83.8675302050823, 24.633875631117437],
           [83.86963305694998, 24.630169663082295],
           [83.87345252258719, 24.631496022165724]]],
         [[[84.06988708444021, 24.69769589822598],
           [84.06984416909597, 24.697111051918625],
           [84.07054154343984, 24.697033072203542],
           [84.07056300111196, 24.697432717727445],
           [84.07033769555471, 24.698348973357866],
           [84.0697046942272, 24.69830998389385]]],
         [[[84.01629051283626, 24.703346256577806],
           [84.01719173506527, 24.70295637702982],
           [84.01758333758144, 24.703653285862867],
           [84.01666602209835, 24.704072403982593]]]]),
    baresoil = 
    /* color: #7e3939 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[84.31894666724746, 24.99175950380521],
           [84.32602769904678, 24.996777129704597],
           [84.32122118049209, 25.00187233860083],
           [84.31650049262588, 24.997982885243843]]],
         [[[84.24418520464455, 24.93443242439204],
           [84.24201797976052, 24.931980739860446],
           [84.24118113054787, 24.928750668330462],
           [84.24347710146462, 24.92849770734764],
           [84.24639534487282, 24.931280249608047]]],
         [[[84.1613342346378, 24.79916326631694],
           [84.15845890657384, 24.792345455891112],
           [84.16802902833898, 24.789735109263585],
           [84.17360802308995, 24.79698160775808]]],
         [[[84.23659047847508, 24.9650758606717],
           [84.23804960017918, 24.964453370160204],
           [84.24122533565281, 24.963753064571296],
           [84.24298486476658, 24.964998049529957],
           [84.24139699702977, 24.966515357919864],
           [84.23877916103123, 24.96744907686117]]],
         [[[83.87607184397349, 24.609423954116842],
           [83.87508479105601, 24.607590130315703],
           [83.8755139444984, 24.60575627963262],
           [83.87677994715342, 24.60439062868317],
           [83.87768116938243, 24.60561971520846],
           [83.87858239161143, 24.607141424653836],
           [83.87969819056163, 24.60872164179482]]],
         [[[83.91614194020102, 24.63002318442849],
           [83.91266579731771, 24.628813843342556],
           [83.91270871266195, 24.62748745579268],
           [83.91519780262777, 24.62830669682387]]],
         [[[83.9861248379925, 24.65392030302144],
           [83.98596390545161, 24.653179237153246],
           [83.98495539486201, 24.65276969886511],
           [83.98638233005794, 24.65212613598365],
           [83.98746594249995, 24.653257244293897]]],
         [[[84.01868328072133, 24.670546779676354],
           [84.01645168282094, 24.66617890990053],
           [84.02057155586782, 24.663136910257908],
           [84.02400478340688, 24.667075895635932]]]]),
    other = 
    /* color: #848484 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[84.1552015210633, 24.774162676225775],
           [84.16007241263435, 24.772818352419005],
           [84.16172465338752, 24.777318857518164],
           [84.156767931128, 24.77872157900063]]],
         [[[84.1818197633271, 24.906409834150697],
           [84.18158372893379, 24.905251837204844],
           [84.18225964560554, 24.904989096889526],
           [84.18264588370369, 24.906176289422966],
           [84.18326815619514, 24.905923282135802],
           [84.18354710593269, 24.906633647433328],
           [84.18212017073677, 24.907207775302012]]],
         [[[84.18228110327766, 24.91171312668547],
           [84.1831715966706, 24.911430938879878],
           [84.18346127524421, 24.912316422587452],
           [84.18262442603157, 24.91263753049349]]],
         [[[84.22651652494623, 24.883363427877956],
           [84.23177365461542, 24.879840090367022],
           [84.23283580938532, 24.880307279020084],
           [84.22769669691279, 24.884112854111528]]],
         [[[84.23127422970364, 24.970441409859596],
           [84.23141370457242, 24.9697703164069],
           [84.23258314770291, 24.969128397505354],
           [84.2328513686044, 24.970013466631443],
           [84.23318396252225, 24.970986062724485],
           [84.23186431568692, 24.97157934256587]]],
         [[[84.17207891616806, 24.935010982883572],
           [84.17274410400375, 24.934728848392144],
           [84.17305524024948, 24.93503044041089],
           [84.17346293601975, 24.935876839876048],
           [84.17236859474167, 24.936178429085327]]]]),
    water = 
    /* color: #7c6cff */
    /* shown: false */
    ee.Geometry({
      "type": "GeometryCollection",
      "geometries": [
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.24774084488108,
                24.875499044665315
              ],
              [
                84.2484650413151,
                24.875255707993123
              ],
              [
                84.24872253338053,
                24.87605871719288
              ],
              [
                84.24797151485636,
                24.876209585005686
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.17151188141419,
                24.88193551312723
              ],
              [
                84.17082523590638,
                24.878470534245185
              ],
              [
                84.17363619095399,
                24.877925472541847
              ],
              [
                84.17649006134583,
                24.882052308475078
              ],
              [
                84.17696213013245,
                24.885283602642218
              ],
              [
                84.17419409042908,
                24.886217937007906
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.2063384262468,
                24.905186867768673
              ],
              [
                84.21118786014573,
                24.905537187503356
              ],
              [
                84.21131660617844,
                24.907483390141493
              ],
              [
                84.20728256382004,
                24.90693845649693
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.23445592431405,
                24.947746691632677
              ],
              [
                84.233726363462,
                24.945217448381488
              ],
              [
                84.23162351159432,
                24.94420573653918
              ],
              [
                84.2331684639869,
                24.943077278912362
              ],
              [
                84.23467050103524,
                24.94490615331504
              ],
              [
                84.23587213067391,
                24.947629958471996
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.22216067818978,
                24.939224880172237
              ],
              [
                84.22085176019051,
                24.938076919879137
              ],
              [
                84.21969304589608,
                24.93671491921889
              ],
              [
                84.2208303025184,
                24.936033913243417
              ],
              [
                84.22190318612435,
                24.937181892569747
              ],
              [
                84.222740035337,
                24.938485517141565
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.27194226660458,
                24.97674568589499
              ],
              [
                84.27456010260312,
                24.97445045423688
              ],
              [
                84.27692044653622,
                24.97682348960747
              ],
              [
                84.27520383276669,
                24.97837955352206
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.37961587873087,
                25.06156554683165
              ],
              [
                84.37663326230631,
                25.060515917340588
              ],
              [
                84.37693366971598,
                25.058941456245435
              ],
              [
                84.37834987607584,
                25.05973840821702
              ],
              [
                84.38040981259928,
                25.060574230325972
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.39328340717157,
                25.065877057579645
              ],
              [
                84.39748911090692,
                25.066557344246792
              ],
              [
                84.39751056857904,
                25.068345508326594
              ],
              [
                84.39326194949945,
                25.067587485436654
              ]
            ]
          ],
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.16498601666781,
                24.77754601666064
              ],
              [
                84.16618764630648,
                24.77710766374868
              ],
              [
                84.16664898625704,
                24.778598057333305
              ],
              [
                84.16602135085307,
                24.778909773277114
              ],
              [
                84.16552245847075,
                24.778987699763988
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.06744052972462,
                24.782623239822016
              ],
              [
                84.06568100475384,
                24.780460777323647
              ],
              [
                84.06673242821198,
                24.7798958044907
              ],
              [
                84.06759073070106,
                24.781707607193425
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.09479595287624,
                24.807787664516937
              ],
              [
                84.09717775448146,
                24.809287428176972
              ],
              [
                84.09951664074245,
                24.81020285941421
              ],
              [
                84.09943081005397,
                24.811722070801284
              ],
              [
                84.09698463543239,
                24.811761024694537
              ],
              [
                84.09322954281154,
                24.809248473506262
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.15862360831557,
                24.869341852660444
              ],
              [
                84.15935316916762,
                24.86977014537683
              ],
              [
                84.16001835700331,
                24.871074482234764
              ],
              [
                84.1603402220851,
                24.871969989123073
              ],
              [
                84.15986815329848,
                24.87259294660981
              ],
              [
                84.15858069297133,
                24.87179478176418
              ],
              [
                84.15750780936537,
                24.87070459706132
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        },
        {
          "type": "Polygon",
          "coordinates": [
            [
              [
                84.136252144493,
                24.842267125562742
              ],
              [
                84.13790438524617,
                24.840845650701834
              ],
              [
                84.13929913393392,
                24.842228181263515
              ],
              [
                84.14056513658895,
                24.843630168314608
              ],
              [
                84.13955662599935,
                24.84495425261233
              ],
              [
                84.13708899370565,
                24.844331155884085
              ]
            ]
          ],
          "geodesic": true,
          "evenOdd": true
        }
      ],
      "coordinates": []
    }),
    sediment = 
    /* color: #fffc7b */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[83.93129251313024, 24.568832644057615],
           [83.92910383057409, 24.567037256127765],
           [83.93043420624548, 24.56535893545758],
           [83.93197915863806, 24.56719337783831],
           [83.93425367188269, 24.56723240823556],
           [83.93425367188269, 24.568832644057615],
           [83.93232248139196, 24.56828622436686]]],
         [[[83.9153280050736, 24.554624957935058],
           [83.91683004212194, 24.554624957935058],
           [83.91816041779333, 24.556771826955682],
           [83.91781709503942, 24.55794283092957],
           [83.91614339661413, 24.55724022985753],
           [83.91399762940222, 24.555756947999292]]],
         [[[84.26365642341509, 24.9344296711361],
           [84.26060943397417, 24.933768110258622],
           [84.26125316413774, 24.931861238448175],
           [84.26365642341509, 24.932328230190834],
           [84.26477222236528, 24.932367146089515]]],
         [[[84.46161630190771, 25.141591126721664],
           [84.4609296563999, 25.140542183779594],
           [84.45994260348242, 25.141086081244936],
           [84.45959928072851, 25.13906587844534],
           [84.46024301089209, 25.135646997559043],
           [84.46140172518652, 25.134986520901027],
           [84.4618308786289, 25.13580240331235],
           [84.46303250826757, 25.138483121425814],
           [84.46333291567724, 25.140075984023596],
           [84.46247460879248, 25.142290417009455]]],
         [[[84.43695126722415, 25.09100506494855],
           [84.43636118124087, 25.089994553765987],
           [84.43603931615908, 25.088954884513072],
           [84.43630753706057, 25.086603450446002],
           [84.43710147092898, 25.087730589768956],
           [84.43832455823977, 25.08992653829049],
           [84.43893610189517, 25.091558899268016],
           [84.43709074209292, 25.091928120755007]]],
         [[[84.42227630497776, 25.085486156309717],
           [84.42193298222385, 25.08437843019768],
           [84.42101030232273, 25.082473895201822],
           [84.42070989491306, 25.081677091156486],
           [84.4218686092075, 25.081793696950502],
           [84.42279128910862, 25.082648802712693],
           [84.42334918858371, 25.0844950334184],
           [84.42347793461643, 25.085350120309624]]],
         [[[84.47895049316784, 25.18604417483661],
           [84.47937964661023, 25.181383836033667],
           [84.48023795349499, 25.178432195938957],
           [84.48384284241101, 25.178820573719857],
           [84.48410033447644, 25.18518979273302]]],
         [[[84.13847051564385, 24.838800851522063],
           [84.1392000764959, 24.83669778293287],
           [84.14053045216728, 24.835490449636552],
           [84.14151750508476, 24.836931458985013],
           [84.1404446214788, 24.837982995760903],
           [84.139757975971, 24.839307140475675]]],
         [[[84.19357296509182, 24.897327155491613],
           [84.19494625610744, 24.89629558703361],
           [84.197928872532, 24.896139877838362],
           [84.1984867720071, 24.897054666548012],
           [84.19754263443386, 24.897541253525375],
           [84.19816490692531, 24.898825833930132],
           [84.19443127197658, 24.89863120139474]]],
         [[[84.18741461319362, 24.89793052172632],
           [84.18876644653713, 24.89629558703361],
           [84.19078346771633, 24.89835871532962],
           [84.18971058411037, 24.899215098080294],
           [84.1900753645364, 24.90024664214138],
           [84.18910976929104, 24.90046073511152],
           [84.1871571211282, 24.89913724534847]]]]),
    wet_sediment = 
    /* color: #d3d639 */
    /* shown: false */
    ee.Geometry.MultiPolygon(
        [[[[84.15725431243163, 24.854619935575],
           [84.15745816034885, 24.85447390894692],
           [84.15766200826607, 24.854580995157708],
           [84.15770492361706, 24.854882783071094],
           [84.15734014313362, 24.854921723393378]]],
         [[[84.20840075817702, 24.90426975952586],
           [84.20818618145583, 24.903520455631],
           [84.20748880711196, 24.902819803717342],
           [84.20965603199599, 24.90329663670207],
           [84.21068600025771, 24.905242874676293],
           [84.20908740368483, 24.905096907892894]]],
         [[[84.2157758428277, 24.91383074391755],
           [84.21459567086114, 24.91264849029977],
           [84.21474587456598, 24.912526858626325],
           [84.21586167351617, 24.913694517740822]]],
         [[[84.21654907149399, 24.911825471482643],
           [84.2166241733464, 24.911124866725597],
           [84.21769169253433, 24.91102756019468],
           [84.21758440417373, 24.911801144995255],
           [84.21750930232132, 24.912545533336875],
           [84.21791163367355, 24.913119633695768],
           [84.2173805562886, 24.913538044138537]]],
         [[[84.23006484357488, 24.94294366839874],
           [84.22920116844058, 24.942369706939758],
           [84.22867009488714, 24.94155253679634],
           [84.22707149831426, 24.94072563294564],
           [84.22674963323247, 24.940511609868395],
           [84.22737190572393, 24.939840353259964],
           [84.22840187398565, 24.939947365428097],
           [84.22864863721502, 24.93983062487642],
           [84.22901341764104, 24.939645785443446],
           [84.22981808034551, 24.940180846199553],
           [84.22966787664068, 24.940579708160577],
           [84.23025796262395, 24.941406612990683],
           [84.23046181050908, 24.941873568560386],
           [84.22987172452581, 24.942379435096946],
           [84.23015067426336, 24.942739377329296]]],
         [[[84.23068522457272, 24.945621066941708],
           [84.22997175697476, 24.945178445483467],
           [84.23035799507291, 24.94479905439623],
           [84.23092662338406, 24.944979022108946],
           [84.23116265777738, 24.94525140517399]]],
         [[[84.2431806822152, 24.955533836495746],
           [84.24280517295311, 24.95489184334135],
           [84.24329869941185, 24.954347119251906],
           [84.24415700629662, 24.95427902857128],
           [84.2446934480996, 24.954600027164577],
           [84.2446934480996, 24.955660289298205],
           [84.2442428369851, 24.956185553395144]]]]),
    center = 
    /* color: #98ff00 */
    /* shown: false */
    ee.Geometry.Point([84.2047028760486, 24.90192702360151]);
/***** End of imports. If edited, may not auto-convert in the playground. *****/
// var aoi=ee.FeatureCollection("users/andoshah/PL_NR").first().geometry();
// Zoom to regions of interest
Map.centerObject(aoi, 10); 

var START_DATE = '2022-11-13';
var END_DATE = '2022-12-31';

// Import Sentinel 1 and filter data series:
var s1Collection =  ee.ImageCollection('COPERNICUS/S1_GRD')
  .filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VV'))
  .filter(ee.Filter.eq('instrumentMode', 'IW'))
  .filter(ee.Filter.eq('orbitProperties_pass', 'ASCENDING'))
  //.filterBounds(aoi)
  //.filterBounds(Map.getBounds(true))
  .filterDate(START_DATE, END_DATE);
  //.filter(ee.Filter.contains({leftField: ".geo", rightValue: aoi})) // Filter partial S1-Images of AOI
  // .map(function(image){return image.clip(Map.getBounds(true))})
  
print(s1Collection); //print to get information about the collection



//Calculate median image of time period
var s1_image = ee.Image(s1Collection.median()); // convert collection to median image (i.e., median VV backscatter over time)

// Define visualization parameters in an object literal.
var s1_band = 'VV';
var s1_band2 = 'VH'
var s1_band3 = 'angle'

var vizParams = {
  bands: [s1_band],// s1_band2, s1_band3],
  min: -28,
  max: 0,
};

// Display S1-Image
Map.addLayer(s1_image, vizParams, 'S1-Image');

//Now add the S-2 images
function maskS2clouds(image) {
  var qa = image.select('QA60');

  // Bits 10 and 11 are clouds and cirrus, respectively.
  var cloudBitMask = 1 << 10;
  var cirrusBitMask = 1 << 11;

  // Both flags should be set to zero, indicating clear conditions.
  var mask = qa.bitwiseAnd(cloudBitMask).eq(0)
      .and(qa.bitwiseAnd(cirrusBitMask).eq(0));

  return image.updateMask(mask).divide(10000);
}

var s2Collection = ee.ImageCollection('COPERNICUS/S2_SR_HARMONIZED')
                  .filterDate(START_DATE, END_DATE)
                  //.filterBounds(aoi)
                  // Pre-filter to get less cloudy granules.
                  .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE',15));
                  //.sort('CLOUD_COVERAGE_ASSESSMENT')
                  // .sort('CLOUD_COVER')
                  //.map(maskS2clouds);

                  
print(s2Collection);
var s2 = s2Collection.median();

//To keep a single image, we need to do some sophisticated mosaicing
// var s2 = s2Collection.first();
print(s2);
// var s2 = s2Collection.first();

var visualization = {
  min: 0.0,
  max: 3000,
  bands: ['B4', 'B3', 'B2'],
};


Map.addLayer(s2, visualization, 'S2-RGB');


//Modified TGSI
var namedVarsExp = '(R - B + SWIR2 - NIR) / (R + G + B + SWIR2 + NIR)';
// var namedVarsExp = '(R - B + SWIR1 - SWIR2 - NIR) / (R + G + B + SWIR1 + SWIR2 + NIR)';
var mTGSI_s2 = ee.Image().expression({
  expression: namedVarsExp,
  map: 
    { 'R': s2.select('B4'),
      'G': s2.select('B3'),
      'B': s2.select('B2'),
      'NIR': s2.select('B8'),
      'SWIR2': s2.select('B12'),
      'SWIR1': s2.select('B11')
    }
}).rename('mTGSI');

s2 = s2.addBands(mTGSI_s2).addBands(s1_image.select(s1_band));

print(s2);



var viridis = ['#440154', '#3b528b', '#21918c', '#5ec962', '#fde725']; 
var blue_yellow = ['#0000FF','#FFFF31']
var blue_yellow_orange = ['#0000FF','#2c7873','#FFFF31','#f85d31']
var green_blue_yellow_orange = ['#008080','#0039e6','#FFFF31','#f85d31']

var vizParamsTGSI = {bands: ['TGSI'], min: -0.05, max: 0.3, palette: green_blue_yellow_orange};
var vizParams_mTGSI = {bands: ['mTGSI'], min: -0.45, max: 0.25, palette: green_blue_yellow_orange};


// Map.addLayer(TGSI_s2, vizParamsTGSI, 'TGSI'); 
// Map.addLayer(mTGSI_s2, vizParams_mTGSI, 'mTGSI'); 


// print(Chart.image.histogram(TGSI_s2.select('TGSI'), aoi, 10));
print(Chart.image.histogram(mTGSI_s2.select('mTGSI'), aoi, 10));



var sandmask = function(image, band, min, max) {
  var mask_band = image.select(band);
  var mask = mask_band.lte(max).and(mask_band.gte(min)).not(); 
  return image.mask(mask);
};

// var sand_mask_mTGSI = sandmask(mTGSI_s2, 'mTGSI',0.13, 0.3);
// Map.addLayer(sand_mask_mTGSI, {bands: ['mTGSI'], palette:'black'}, 'sand_mask_manual', false);


var cluster_image = mTGSI_s2.select('mTGSI').clip(aoi);

/* Now lets see if we can use k-means to cluster this layer*/
// Get pixels from the image into a training sample (appropriate for unsupervised classification)
var training = cluster_image.sample({
  region: aoi,
  scale: 10,
  numPixels: 50000 //this is an approximate guess on how many pixels we can sample. should be <1 million; this number could be adjusted depending on how large the study area is
});

//(optional) check that we now have a set of 5000 training features:
// print(training)

var n_clusters = 4;


//Specify our clusterer using K-Means methods, our desired # clusters & earlier designated training sample 
var clusterer = ee.Clusterer.wekaKMeans(n_clusters).train(training);
//Apply clusterer to the image:
var result_mTGSI = mTGSI_s2.select('mTGSI').cluster(clusterer);
//visualize clusters using random colors:
Map.addLayer(result_mTGSI.randomVisualizer(), {}, 'mTGSI clusters');

//Make only sand (cluster #1) transparent
var cluster_not1=result_mTGSI.remap([0,2,3,],[0,2,3]); 
Map.addLayer(cluster_not1, {palette:'black'}, '[mask]sand_kmeans_mTGSI')



/** RAW K-Mean on all bands of interest**/
n_clusters = 6;

var training_image_s2 = s2.select(['B[2-4]','B8','B11','B12','VV']).clip(aoi); 

var training = training_image_s2.sample({
  region: aoi,
  scale: 10,
  numPixels: 50000 //this is an approximate guess on how many pixels we can sample. should be <1 million; this number could be adjusted depending on how large the study area is
});

//Specify our clusterer using K-Means methods, our desired # clusters & earlier designated training sample 
var clusterer = ee.Clusterer.wekaKMeans(n_clusters).train(training);
//Apply clusterer to the image:
var result_raw = s2.cluster(clusterer);
//visualize clusters using random colors:
Map.addLayer(result_raw.randomVisualizer(), {}, 'raw band clusters');
//Make only sand (cluster #1) and wet-sand (possibly cluster #3) transparent
var raw_cluster_not0=result_raw.remap([0,2,4,5],[0,2,4,5]); 
Map.addLayer(raw_cluster_not0, {palette:'black'}, '[mask]sand_kmeans_bands')



/********************Supervised Classification***********************************/

//Setup classes
var tsamples = ee.FeatureCollection([
  ee.Feature(sediment, {'class': 0}),
  ee.Feature(wet_sediment, {'class': 1}),
  ee.Feature(baresoil, {'class': 2}),
  ee.Feature(water, {'class': 3}),
  ee.Feature(greenveg, {'class': 4}),
  ee.Feature(other, {'class': 5})
  // ee.Feature(built, {'class': 6})
//…add your own polygons as necessary ending with comma at the end of the last one: ,
]);

/********Setup Legend***********/
var legend_keys = ['Sediment', 'Wet Sediment','Bare/Senescent', 'Water','Green Vegetation','Other'];
var palette = ['f3ff4a','F0F3F4','8c411d', '2E86C1','00854d','551a4d'];
var num_classes = palette.length;

var legend_colors = palette; 

// adding a legend as a small rectangular panel in the Map view:
// set position of panel
var legend = ui.Panel({
  style: {
    position: 'bottom-left',
    padding: '8px 15px'
  }
});

// Create legend title
var legendTitle = ui.Label({
  value: 'Cover types',
  style: {
    fontWeight: 'bold',
    fontSize: '18px',
    margin: '0 0 4px 0',
    padding: '0'
    }
});

// Add the title to the panel
legend.add(legendTitle);
    
// Create and style 1st row of the legend.
var makeRow = function(color, name) {
      
      // Create the label that is the colored box:
      var colorBox = ui.Label({
        style: {
          backgroundColor: '#' + color,
          // Use padding to give the box height and width.
          padding: '8px',
          margin: '0 0 4px 0'
        }
      });
      
      // Create the label filled with the description text:
      var description = ui.Label({
        value: name,
        style: {margin: '0 0 4px 6px'}
      });
      
      // return the panel
      return ui.Panel({
        widgets: [colorBox, description],
        layout: ui.Panel.Layout.Flow('horizontal')
      });
};

//  Specify palette with the colors
var palette2 =legend_colors;

// name of the legend
var names = legend_keys;
// Add color and and names (here i< should be less than your number of classes, 6 in lecture example)
for (var i = 0; i < palette.length; i++) {
  legend.add(makeRow(palette2[i], names[i]));
  }  

// add legend to map (alternatively you can print the legend to the console if you’d like)  
Map.add(legend);  


/**********Random Forest***************/

//Applying a Random Forest classifier:

//Generate a training region:
var training_rf = s2.select(['B[2-4]','B8','B11','B12','mTGSI','VV']) //doing this to reduce memory footprint
                    .clip(aoi).sampleRegions({
                    // Get the sample from the polygons FeatureCollection
                    collection: tsamples,
                    // Keep this list of properties from the polygons:
                    properties: ['class'],
                    // Set the scale to get Sentinel-2 pixels in the polygons:
                    scale: 10
                  });
                  

var rforest_20_VV = ee.Classifier.smileRandomForest(20)
    .train({
      features: training_rf,
      classProperty: 'class',
      inputProperties: ['B2', 'B3', 'B4', 'B8', 'B11', 'B12','VV']
    });

    
var rforest_20 = ee.Classifier.smileRandomForest(20)
    .train({
      features: training_rf,
      classProperty: 'class',
      inputProperties: ['B2', 'B3', 'B4', 'B8', 'B11', 'B12']
    });

// Classify the input imagery.
// var rfresult_12 = image.classify(rforest_12);
var rfresult_20 = s2.classify(rforest_20);
var rfresult_20_VV = s2.classify(rforest_20_VV);

// print(s2_select_bands);

// Map.addLayer(rfresult_12,
//             {min: 0, max: 6, palette: palette},
//             'random forest with 12 trees');
             
Map.addLayer(rfresult_20,
            {min: 0, max: num_classes-1, palette: palette},
            'RF-20');
            
Map.addLayer(rfresult_20_VV,
            {min: 0, max: num_classes-1, palette: palette},
            'RF-20-VV');
             

//Now show only sand and wet sand classes
//Make only sand (cluster #1) transparent
var rfresult_20_VV_sands = rfresult_20_VV.remap([2,3,4,5],[2,3,4,5]); 
Map.addLayer(rfresult_20_VV_sands, {palette:'black'}, '[mask]sand+wet sand(RF-20-VV)')